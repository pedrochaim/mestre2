---
title: "Índice de Microsubtemas (R) — links com base_dir"
format:
  html:
    toc: true
execute:
  echo: false
  warning: false
  message: false
params:
  create_dummy: false
  base_dir: "info"
  subdir_prefix: "subtemas_"
---

Este índice é gerado em **R** ao renderizar o arquivo no Quarto.
Ele varre a pasta `params$base_dir` (por padrão, `./info/`) e produz uma lista de links para:

```
microsubtemas_<tema_clean>_<subtema_clean>.md
```

> Em `_quarto.yml`, garanta que `info/**` seja copiado para a saída:
>
> ```yaml
> project:
>   output-dir: docs
>   resources:
>     - info/**
> render:
>   - "*.qmd"
>   - "!info/"
> ```

## Lista de links por `<tema_clean>`

```{r}
#| results: asis
base_dir      <- getOption("base_dir",          default = params$base_dir)
subdir_prefix <- getOption("subdir_prefix",     default = params$subdir_prefix)

pattern <- "^microsubtemas_([^_]+)_(.+)\\.[Mm][Dd]$"

entries <- list()
subdirs <- list.dirs(base_dir, recursive = FALSE, full.names = TRUE)
# Normaliza e filtra
subdirs_norm <- gsub("\\\\", "/", subdirs)
subdirs <- subdirs[grepl(paste0("^", base_dir, "/", subdir_prefix), subdirs_norm)]

for (sd in subdirs) {
  files <- list.files(sd, pattern = "\\.[Mm][Dd]$", full.names = FALSE)
  for (nm in files) {
    if (grepl(pattern, nm)) {
      stem <- sub("\\.[Mm][Dd]$", "", nm)
      tmp  <- sub("^microsubtemas_", "", stem)
      tema <- sub("_.+$", "", tmp)
      subtema <- sub("^[^_]+_", "", tmp)
      rel <- file.path(base_dir, basename(sd), nm, fsep = "/")
      rel <- gsub("\\\\", "/", rel)
      entries[[length(entries) + 1]] <- list(tema = tema, subtema = subtema, rel = rel)
    }
  }
}

if (length(entries) == 0) {
  cat("> **Nenhum arquivo `microsubtemas_*_*.md` encontrado.** Verifique `base_dir`/`subdir_prefix`.\n")
} else {
  temas <- sort(unique(vapply(entries, `[[`, character(1), "tema")))
  for (t in temas) {
    grupo <- entries[vapply(entries, function(e) identical(e$tema, t), logical(1))]
    ord <- order(tolower(vapply(grupo, `[[`, character(1), "subtema")))
    grupo <- grupo[ord]
    tema_label <- tools::toTitleCase(gsub("[-_]", " ", t))
    cat("### ", tema_label, "\n\n", sep = "")
    for (e in grupo) {
      lbl <- tools::toTitleCase(gsub("[-_]", " ", e$subtema))
      cat(sprintf("- [%s](%s)\n", lbl, e$rel))
    }
    cat("\n")
  }
}
```
